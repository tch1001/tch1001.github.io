<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-01-31T16:35:13+08:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">TCH’s Lab Book</title><subtitle>Just a big nerd for almost everything STEM. 
</subtitle><author><name>tch1001</name><email>tanchienhao@gmail.com</email></author><entry><title type="html">Compiling a Minimal Kernel</title><link href="http://localhost:4000/2023/01/31/minimal-kernel.html" rel="alternate" type="text/html" title="Compiling a Minimal Kernel" /><published>2023-01-31T00:00:00+08:00</published><updated>2023-01-31T00:00:00+08:00</updated><id>http://localhost:4000/2023/01/31/minimal-kernel</id><content type="html" xml:base="http://localhost:4000/2023/01/31/minimal-kernel.html">&lt;p&gt;The exploration logs are found at &lt;a href=&quot;https://github.com/tch1001/kernel&quot;&gt;here&lt;/a&gt;.
Let’s try to compile a kernel that is as small as possible.&lt;/p&gt;

&lt;h2 id=&quot;measuring-size&quot;&gt;Measuring Size&lt;/h2&gt;
&lt;p&gt;The kernel size can be determined using&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lh&lt;/span&gt; vmlinux
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt;  1 tanchienhao  staff   2.2K Jan 31 12:12 	README.md
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, I will measure the size of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; instead of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vmlinuz&lt;/code&gt; since compression is cheating.&lt;/p&gt;

&lt;h2 id=&quot;building-the-kernel&quot;&gt;Building the Kernel&lt;/h2&gt;
&lt;p&gt;Of course the small kernel must still be functional, so we will test it using &lt;a href=&quot;https://www.qemu.org/&quot;&gt;qemu&lt;/a&gt;. One can also use virtualbox but I chose qemu because I will be working remotely using SSH and VNC takes too much mobile data lol.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git &lt;span class=&quot;nt&quot;&gt;--depth&lt;/span&gt; 1 &lt;span class=&quot;nt&quot;&gt;--branch&lt;/span&gt; v6.1.4
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;linux
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git log
commit 2cb8e624295ffa0c4d659fcec7d9e7a6c48de156 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;grafted, HEAD, tag: v6.1.4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    Author: Greg Kroah-Hartman &amp;lt;gregkh@linuxfoundation.org&amp;gt;
        Date:   Sat Jan 7 11:12:04 2023 +0100
	Linux 6.1.4
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; libncurses5 libncurses5-dev bison flex
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make menuconfig 
&lt;span class=&quot;c&quot;&gt;# go enable PVH if u want to run in QEMU&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;vim .config &lt;span class=&quot;c&quot;&gt;# remove &quot;debian&quot; things if they complain, and also the &quot;certs/signing_key.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; libssl-dev libelf-dev
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make &lt;span class=&quot;nt&quot;&gt;-j12&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# change -jN to your liking, my 32-core computer can take N=12 or more but my Thinkpad laptop could only take N=2 before crashing&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# if they prompt something involving certs, just press enter (default choices)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;running-the-kernel-in-qemu&quot;&gt;Running the Kernel in QEMU&lt;/h2&gt;
&lt;p&gt;Important: Don’t forget to enable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONFIG_PVH=y&lt;/code&gt; in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.config&lt;/code&gt; if you want to run in QEMU.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ls -lh vmlinux
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; should exist, if it doesn’t, something went wrong and go back to &lt;a href=&quot;#building-the-kernel&quot;&gt;build&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Otherwise, let’s run our kernel!&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ mkinitramfs -o ramdisk.img
$ dd if=/dev/zero of=roorfs.ext2 bs=1024k count=256
$ mkfs.ext2 rootfs.ext2
$ qemu-system-x86_64 -kernel ./vmlinux -initrd ramdisk.img -hda rootfs.ext2 -nographic --append &quot;console=tty0 console=ttyS0 root=/dev/sda init=/bin/sh&quot; -m 512 -vga none -display none -serial mon:stdio
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Doesnt seem to work right now&lt;/p&gt;

&lt;h2 id=&quot;running-the-kernel-on-hardware&quot;&gt;Running the Kernel on Hardware&lt;/h2&gt;
&lt;p&gt;If you’re on ubuntu, you can do&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ update-grub2 # make sure you're using the grub bootloader
$ make modules_install
$ make install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When booting up, press and hold &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;Shift&amp;gt;&lt;/code&gt; to go to the grub menu, then go to advanced options to select the kernel you want to boot with.&lt;/p&gt;</content><author><name>tch1001</name><email>tanchienhao@gmail.com</email></author><summary type="html">The exploration logs are found at here. Let’s try to compile a kernel that is as small as possible.</summary></entry></feed>