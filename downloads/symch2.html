<style>
    .latex-input {
        visibility: hidden;
    }
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
    }
    .add-entity {
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1;
    }
    body {
        margin: 0;
        padding: 0;
    }
</style>
<script>
    MathJax = {
        loader: { load: ['output/svg'] }
    };
</script>
<script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
<script>
    // create a javascript class for each equation
    const MouseState = {
        NONE: 0,
        HOVER: 1,
        SELECTED: 2,
        DRAGGING: 3,
    }
    class Entity {
        constructor(code, node) {
            this.code = code;
            this.node = node;
            this.mouse_state = MouseState.NONE;
        }
        onmouseover(e) {
            if(this.mouse_state != MouseState.DRAGGING) this.mouse_state = MouseState.HOVER;
            this.node.style.border = '1px solid red';
        }
        onmousedown(e) {
            if (e.button == 0) { // left click
                if(this.mouse_state != MouseState.DRAGGING) this.mouse_state = MouseState.SELECTED;
            }
            this.node.style.border = '1px solid blue';
        }
        onmouseout(e) {
            // console.log('out', e);
            this.node.style.border = '1px solid white';
        }
        onmouseup(e) {
            // console.log('up', e)
            if (e.button == 0) { // left click
                this.mouse_state = MouseState.NONE;
            }
            this.node.style.border = '1px solid white';
        }
        onmousemove(e) {
            if (this.mouse_state == MouseState.SELECTED) {
                this.mouse_state = MouseState.DRAGGING;
            }
            if (this.mouse_state == MouseState.DRAGGING) {
                // change in x and y
                var dx = e.movementX;
                var dy = e.movementY;
                // scale
                const scale = 0.5;
                dx *= scale;
                dy *= scale;
                // move the node
                this.node.style.left = parseInt(this.node.style.left) + dx;
                this.node.style.top = parseInt(this.node.style.top) + dy;
            }
        }
    }
    var entities = [];
    function math_render(code) {
        MathJax.tex2svgPromise(code).then((guy) => {
            // console.log(node.children[0])
            // absolute positioning for node 
            var node = guy.children[0];
            node.style.position = 'absolute';
            node.style.top = 0;
            node.style.left = 0;
            const entity = new Entity(code, node);
            node.onmousedown = entity.onmousedown.bind(entity);
            node.onmousemove = entity.onmousemove.bind(entity);
            node.onmouseup = entity.onmouseup.bind(entity);
            node.onmouseover = entity.onmouseover.bind(entity);
            node.onmouseout = entity.onmouseout.bind(entity);
            entities.push(entity);
            document.getElementById('output').appendChild(node)
        }).catch((err) => {
            console.log("err")
        })
    }
    function init(){
        document.onmouseup = function(e){
            for(var i = 0; i < entities.length; i++){
                entities[i].onmouseup(e);
            }
        }
        document.onmousemove = function(e){
            for(var i = 0; i < entities.length; i++){
                entities[i].onmousemove(e);
            }
        }
    }
    function render() {
        init()
        math_render(document.getElementById('latex').value);
    }
</script>

<body onload='render()'>
    <textarea class="latex-input" id='latex'>\begin{aligned}
  W_\alpha &= -\frac{1}{4} \bar{D}^2 D_\alpha V \\
  &= -\frac{1}{4} \bar{D}^2 (-\sigma^\nu_{\alpha\dot\beta} \bar\theta^{\dot\beta} A_\nu + i\theta_\alpha \overline{\theta\lambda} - i \bar\theta^2 \lambda_\alpha + \frac{1}{2} \theta_\alpha \bar{\theta}^2 D - i \sigma_{\alpha \dot\alpha}^\mu \bar\theta^{\dot\alpha} \theta^\beta \sigma_{\beta\dot\beta}^\nu \bar\theta^{\dot\beta} \partial_\mu A_\nu - \sigma_{\alpha \dot \alpha}^\mu \bar\theta^{\dot\alpha} \theta^\beta \theta_\beta \bar\theta^{\dot\beta} \partial_\mu \bar\lambda_{\dot\beta}) \\
  &= (a+b-c) (d-e +f)\\
\end{aligned}</textarea>
    <!-- <canvas class='workspace' id='output' width='500' height='500'></canvas> -->
    <div id='output'></div>
    <div class="overlay add-entity">
        <button onclick="math_render(document.getElementById('latex').value)">Add Entity</button>
    </div>
</body>