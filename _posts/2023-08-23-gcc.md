---
layout: post
title: "GCC Toolchain: Cross Compiler Shenanigans"
categories: [Kernel]
---
## Binutils
```
git clone git://sourceware.org/git/binutils-gdb.git --depth 1
cd binutils-gdb
mkdir build
cd build
export PREFIX="/opt/cross"
../configure --target=$(../config.guess) --prefix=$PREFIX
make -j4
ls $PREFIX # nothing
sudo make install
ls $PREFIX # now there's stuff
```
To see the list of targets, `cat ../config.sub`. The target follows the [system triplet pattern](https://wiki.osdev.org/Target_Triplet) of `cpu-vendor-kernel-os`. However, sometimes the vendor is omitted (if `unknown` or `pc`). The `config.sub` file handles cases like `x86_64-linux-gnu`, where `vendor` is omitted and `linux-gnu` is the kernel and OS. To find the `vendor`, we can use `uname -m` or `echo $MACHTYPE` and to find the `kernel-os`, use `uname -s`. To find the `cpu`, we can use `cat /proc/cpuinfo`. There is a nice script called `config.guess` that can be used to guess the target triplet for the machine you're on. `custom-cross-gcc -dumpmachine` is used to find the target of `custom-cross-gcc` (which may differ from the machine you're on for cross compilers). The reason why it's called triplet when there is 4 parts is because historically the `kernel` pretty much determined the `os`. But today we can have different `os` on the same `kernel`, for example, an Android system is designated `aarch64-unknown-linux-android`, and the Ubuntu system is designated `aarch64-unknown-linux-gnu`. Both run on ARM linux but their binaries are very different.

Prefix is where we are installing the binutils. It is where the binaries will be installed when your run `make install`.

In [cross compilation of compilers](https://www.linuxfromscratch.org/lfs/view/11.0/partintro/toolchaintechnotes.html), target is the machine the finished compiler will build FOR. 

## Building gcc
```
git clone git://gcc.gnu.org/git/gcc.git --depth 1 
cd gcc
```

## QEMU Networking
```
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz -netdev user,id=network0 -device e1000,netdev=network0,mac=52:54:00:12:34:56 -netdev user,id=network1 -device e1000,netdev=network1,mac=52:54:00:12:34:57
ip addr # shows eth0 and eth1
```
Add bridge
```
sudo apt install -y bridge-utils
brctl addbr br0
sudo chmod u+s /usr/local/libexec/qemu-bridge-helper
sudo echo "allow br0" > /etc/qemu/bridge.conf 
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz -netdev user,id=network0 -device e1000,netdev=network0,mac=52:54:00:12:34:56 -netdev user,id=network1 -device e1000,netdev=network1,mac=52:54:00:12:34:57 -netdev tap,helper=/usr/local/libexec/qemu-bridge-helper,id=hn0 -device virtio-net-pci,netdev=hn0,id=nic1
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz -netdev tap,helper=/usr/local/libexec/qemu-bridge-helper,id=hn0 -device virtio-net-pci,netdev=hn0,id=nic1
```
[This video](https://youtu.be/6435eNKpyYw)
```
sudo systemctl stop NetworkManager
sudo systemctl stop systemd-networkd
ip link add name brother type bridge
sudo ip link set enp42s0 master brother
sudo arping 192.168.1.9
sudo arping 192.168.184
sudo systemctl restart NetworkManager
sudo ip addr add 192.168.1.191/24 dev br0 brd 192.168.1.255
sudo ip addr add 192.168.1.192/24 dev briyani brd 192.168.1.255
ip a
sudo ip link set enp42s0 master briyani
sudo arping 192.168.192
ifconfig
sudo ip link set down briyani
sudo ip link set up briyani
sudo ip link set down briyani
sudo ip link set up briyani
arping 192.168.1.239
sudo arping 192.168.1.239
sudo ip link set down briyani
sudo ip link set up briyani
ip a
sudo ip addr del dev br0 brd 192.168.0.191
sudo ip addr del dev briyani brd 192.168.0.190
ip a
sudo ip addr del dev briyani brd 192.168.1.192
ip a
sudo ip addr add 192.168.1.192/24 dev briyani brd 192.168.1.255 |

```

# Adding binutils to busybox
Adding files into busybox
```
cd v6.1.4
cd initrd
echo "meow" > hello.txt
find . | cpio -o -H newc | gzip > rootfs.cpio.gz
cd ..
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz
# boot up
cat hello.txt # meow
bin/ld # no such file
```

## Compiling binutils for busybox
The notable difference is the prefix (`make install` path) and static linking (`LDFLAGS=-all-static`).
```
cd binutils-gdb && mkdir build && cd build
export PREFIX=~/Documents/linux/v6.1.4/initrd
make distclean
../configure --target=$(../config.guess) --prefix=$PREFIX --disable-nls
LDFLAGS=-all-static make -j4 # error
LDFLAGS=--static make -j4 # error
LDFLAGS=-static-libgcc make -j4 # error
make LDFLAGS=-static make -j4 # the variable must be inside
make install
cd $PREFIX
ls bin
rm root.cpio.gz
find . | cpio -o -H newc | gzip > root.cpio.gz # might take abit longer
cd .. # back to v6.1.4
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz
ld # this should work yay, but it doesn't
```
## Building glibc
If you run into errors, use the latest stable version.

```
wget https://ftp.gnu.org/gnu/glibc/glibc-2.31.tar.gz && tar xf glibc-2.31.tar.gz && cd glibc-2.31
mkdir build && cd build
../configure --prefix=/opt/meow
make -j8
sudo make install
```

## PLT
[https://youtu.be/Ss2e6JauS0Y?si=eiN5oNE9R6UduYJj](This lecture on PLT) is very good.

```
readelf -h bin/ld
readelf -lW bin/ld
readelf -r /usr/lib/gcc/x86_64-linux-gnu/9/crtbeginT.o
objdump -dx /usr/lib/gcc/x86_64-linux-gnu/9/crtbeginT.o
```
