---
layout: post
title: "GCC Toolchain: Cross Compiler Shenanigans"
categories: [Kernel]
---
## Binutils
```
git clone git://sourceware.org/git/binutils-gdb.git --depth 1
cd binutils-gdb
mkdir build
cd build
export PREFIX="/opt/cross"
../configure --target=$(../config.guess) --prefix=$PREFIX
make -j4
ls $PREFIX # nothing
sudo make install
ls $PREFIX # now there's stuff
```
To see the list of targets, `cat ../config.sub`. The target follows the [system triplet pattern](https://wiki.osdev.org/Target_Triplet) of `cpu-vendor-kernel-os`. However, sometimes the vendor is omitted (if `unknown` or `pc`). The `config.sub` file handles cases like `x86_64-linux-gnu`, where `vendor` is omitted and `linux-gnu` is the kernel and OS. To find the `vendor`, we can use `uname -m` or `echo $MACHTYPE` and to find the `kernel-os`, use `uname -s`. To find the `cpu`, we can use `cat /proc/cpuinfo`. There is a nice script called `config.guess` that can be used to guess the target triplet for the machine you're on. `custom-cross-gcc -dumpmachine` is used to find the target of `custom-cross-gcc` (which may differ from the machine you're on for cross compilers). The reason why it's called triplet when there is 4 parts is because historically the `kernel` pretty much determined the `os`. But today we can have different `os` on the same `kernel`, for example, an Android system is designated `aarch64-unknown-linux-android`, and the Ubuntu system is designated `aarch64-unknown-linux-gnu`. Both run on ARM linux but their binaries are very different.

Prefix is where we are installing the binutils. It is where the binaries will be installed when your run `make install`.

In [cross compilation of compilers](https://www.linuxfromscratch.org/lfs/view/11.0/partintro/toolchaintechnotes.html), target is the machine the finished compiler will build FOR. 

## Building gcc
```
git clone git://gcc.gnu.org/git/gcc.git --depth 1 
cd gcc
```

## QEMU Networking
```
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz -netdev user,id=network0 -device e1000,netdev=network0,mac=52:54:00:12:34:56 -netdev user,id=network1 -device e1000,netdev=network1,mac=52:54:00:12:34:57
ip addr # shows eth0 and eth1
```
Add bridge
```
sudo apt install -y bridge-utils
brctl addbr br0
sudo chmod u+s /usr/local/libexec/qemu-bridge-helper
sudo echo "allow br0" > /etc/qemu/bridge.conf 
qemu-system-x86_64 -kernel ./vmlinux -nographic --append "console=tty0 console=ttyS0 panic=1 root=/dev/sda rootfstype=ext2" -hda rootfs.ext2 -m 1024 -vga none -display none -serial mon:stdio -no-reboot -initrd initrd/root.cpio.gz -netdev user,id=network0 -device e1000,netdev=network0,mac=52:54:00:12:34:56 -netdev user,id=network1 -device e1000,netdev=network1,mac=52:54:00:12:34:57 -netdev tap,helper=/usr/local/libexec/qemu-bridge-helper,id=hn0 -device virtio-net-pci,netdev=hn0,id=nic1
```