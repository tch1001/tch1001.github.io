---
layout: post
title: "TwigSlot Deployment Documentation"
categories: [Kubernetes]
---
This is mainly documentation for myself.

We setup in this order
- Neo4j
- Ory Kratos and Oathkeeper
- Flask server (depends on Neo4j and Ory, will crash if they are not up)
- VueJS frontend 

```
kubectl create namespace twigslot2
kubectl config set-context --current --namespace=twigslot2
k config get-contexts | less -S
```

# Neo4j
I think it's better to just use managed service. The helm chart for clustered neo4j uses a LoadBalancer, which costs $12/month.
```
helm repo add neo4j https://helm.neo4j.com/neo4j
helm repo update
helm template headless neo4j/neo4j-headless-service --set neo4j.name=my-cluster
```

# Ory
```
k port-forward svc/kratos-service 8888:4433
curl http://localhost:8888/health/alive # should be ok (not 404)
vim traefik/traefik-ingress-routes.yaml # make sure tls is OFF
k apply -f traefik/traefik-ingress-routes.yaml
# go to cloudflare add the DNS record (make sure Proxied is OFF)
curl http://staging.twigslot.com/kratos/health/alive # should be ok (not 404)
curl http://staging.twigslot.com/auth/health/alive # should be ok (not 404)
```

# Flask
```
cd kubernetes
vim secrets/flask-secret.yaml
k apply -f secrets/flask-secret.yaml
vim flask/twig-flask-service.yaml
k apply -f flask/twig-flask-service.yaml
k port-forward svc/flask-service 8888:5000
curl http://localhost:8888/ # should be Index (not 404)
curl http://localhost:8888/explore # should be projects (not 404)
curl http://staging.twigslot.com/api # should NOT be Index because of traefik /api clash
curl http://staging.twigslot.com/api/explore # should be projects (not 404)
```

# VueJS
```

```

# Traefik Debugging
```
k port-forward svc/traefik-service 8889:8080
curl http://localhost:8889/dashboard # should be dashboard 
```
If the port-forward connection crashes, make sure `--api.insecure=true` is set